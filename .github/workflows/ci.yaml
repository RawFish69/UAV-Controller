name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build-and-test:
    runs-on: ubuntu-22.04
    container:
      image: osrf/ros:humble-desktop-full

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y \
            python3-pip \
            python3-colcon-common-extensions \
            python3-rosdep \
            libeigen3-dev \
            clang-format \
            python3-flake8 \
            python3-pytest

      - name: Install Python packages
        run: |
          pip3 install --upgrade pip
          pip3 install numpy scipy pyserial

      - name: Initialize rosdep
        run: |
          rosdep update --rosdistro=humble
          cd ros2_ws
          rosdep install --from-paths src --ignore-src -r -y

      - name: Build workspace
        run: |
          cd ros2_ws
          . /opt/ros/humble/setup.sh
          colcon build --symlink-install --cmake-args -DCMAKE_BUILD_TYPE=Release

      - name: Run C++ tests
        run: |
          cd ros2_ws
          . /opt/ros/humble/setup.sh
          . install/setup.sh
          colcon test --packages-select controllers_lqr controllers_pid
          colcon test-result --verbose

      - name: Python import checks
        run: |
          cd ros2_ws
          . /opt/ros/humble/setup.sh
          . install/setup.sh
          python3 -c "import adapters_crsf.packers"
          python3 -c "import sim_dyn.dynamics_node"

      - name: Lint C++ code
        run: |
          cd ros2_ws
          . /opt/ros/humble/setup.sh
          ament_cpplint src/safety_gate src/controllers_lqr src/controllers_pid || true

      - name: Lint Python code
        run: |
          flake8 ros2_ws/src/adapters_crsf ros2_ws/src/sim_dyn --count --select=E9,F63,F7,F82 --show-source --statistics || true
          flake8 ros2_ws/src/adapters_crsf ros2_ws/src/sim_dyn --count --exit-zero --max-complexity=10 --max-line-length=100 --statistics || true

      - name: Check formatting
        run: |
          # Check C++ formatting
          find ros2_ws/src/safety_gate ros2_ws/src/controllers_lqr ros2_ws/src/controllers_pid \
            -name '*.cpp' -o -name '*.hpp' | xargs clang-format --dry-run --Werror || true

  build-docker:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Build Docker image
        run: |
          docker build -t uav_crsf_lqr_pid -f docker/Dockerfile.humble .

